Description: Creates an alarm to alert on high CPU rate for existing legacy EC2 instances

Parameters:

  InstanceId:
    Description: The id of the EC2 instance to monitor.
    Type: String

  ProjectName:
    Description: The project name of the ec2 instance.
    Type: String

  AlertTopicArn:
    Description: The ARN of the SNS topic to send alerts to.
    Type: String
    Default: arn:aws:sns:ap-southeast-1:441221892871:ec2_healthcheck

  CPUHighThreshold:
    Description: The threshold at which the EC2 instance's CPU triggers an alarm (percent).
    Type: Number
    Default: 80

  CPUHighPeriod:
    Description: The number of seconds over which the EC2 instance's CPU is sampled.
    Type: Number
    Default: 300

  CPUHighEvaluationPeriods:
    Description: The number of periods over which data is compared to the specified high CPU threshold.
    Type: Number
    Default: 1


Resources:

  CPUHighAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub legacy-ec2-${ProjectName}-${InstanceId}-CpuTooHigh
      AlarmDescription: !Sub Notify when the legacy ec2 instance '${ProjectName}' ${InstanceId} CPU is too high.
      Namespace: AWS/EC2
      MetricName: CPUUtilization
      Unit: Percent
      Statistic: Average
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: !Ref CPUHighThreshold
      Period: !Ref CPUHighPeriod
      EvaluationPeriods: !Ref CPUHighEvaluationPeriods
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertTopicArn
      OKActions:
        - !Ref AlertTopicArn
      Dimensions:
        - Name: InstanceId
          Value: !Ref InstanceId

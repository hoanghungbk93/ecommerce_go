Description: Creates a Postgres RDS instance.

Parameters:

  EnvironmentName:
    Description: The name of the target environment.
    Type: String
    AllowedValues: [dev, qa, prod]

  VerticalName:
    Description: >
      The name of the vertical that owns the Postgres instance. This should be lower
      cased as the vertical name is used in the naming convention of various resources.
    AllowedPattern: "[a-z0-9-]+"
    Type: String
    Default: ltk

  InstanceName:
    Description: The name of the RDS instance.
    Type: String

  DBName:
    Description: The name of the database on the RDS instance.
    Type: String

  InstanceClass:
    Description: The RDS instance class.
    Type: String
    Default: db.t2.micro

  EngineVersion:
    Description: The version of the database engine.
    Type: String
    Default: 9.6.6

  StorageType:
    Description: The storage type of the RDS instance.
    Type: String
    Default: gp2

  AllocatedStorage:
    Description: The allocated storage size of the RDS instance (in GB).
    Type: String
    Default: 5

  RootPassword:
    Description: The root user's password.
    Type: String
    NoEcho: true

  StorageEncrypted:
    Description: Whether or not the storage should be encrypted.
    Type: String
    AllowedValues: [true, false]
    Default: false

  MaxWorkerProcesses:
    Description: The number of parallel worker processes allowed.
    Type: Number
    MinValue: 0
    Default: 0

  SharedBuffers:
    Description: Sets the static parameter shared_buffers
    Type: Number
    MinValue: 0
    Default: 0

  CPUHighThreshold:
    Description: The threshold at which the RDS instance's CPU triggers an alarm (percent).
    Type: Number
    Default: 80

  CPUHighPeriod:
    Description: The number of seconds over which the RDS instance's CPU is sampled.
    Type: Number
    Default: 300

  CPUHighEvaluationPeriods:
    Description: The number of periods over which data is compared to the specified high CPU threshold.
    Type: Number
    Default: 1

  ReadIOPSHighThreshold:
    Description: The threshold at which the RDS instance's read IOPS triggers an alarm (count/second).
    Type: Number

  ReadIOPSHighPeriod:
    Description: The number of seconds over which the RDS instance's read IOPS are sampled.
    Type: Number
    Default: 300

  ReadIOPSHighEvaluationPeriods:
    Description: The number of periods over which data is compared to the specified read IOPS threshold.
    Type: Number
    Default: 1

  WriteIOPSHighThreshold:
    Description: The threshold at which the RDS instance's write IOPS triggers an alarm (count/second).
    Type: Number

  WriteIOPSHighPeriod:
    Description: The number of seconds over which the RDS instance's write IOPS are sampled.
    Type: Number
    Default: 300

  WriteIOPSHighEvaluationPeriods:
    Description: The number of periods over which data is compared to the specified write IOPS threshold.
    Type: Number
    Default: 1

  UnifiedIOPSHighThreshold:
    Description: >
      The number of unified read and write IOPS at which to trigger an alarm.
    Default: 0
    AllowedPattern: "[0-9]+"
    Type: String

  ReadLatencyHighThreshold:
    Description: The threshold at which the RDS instance's read latency triggers an alarm (milliseconds).
    Type: Number

  ReadLatencyHighPeriod:
    Description: The number of seconds over which the RDS instance's read latency is sampled.
    Type: Number
    Default: 300

  ReadLatencyHighEvaluationPeriods:
    Description: The number of periods over which data is compared to the specified read latency threshold.
    Type: Number
    Default: 1

  WriteLatencyHighThreshold:
    Description: The threshold at which the RDS instance's write latency triggers an alarm (milliseconds).
    Type: Number

  WriteLatencyHighPeriod:
    Description: The number of seconds over which the RDS instance's write latency is sampled.
    Type: Number
    Default: 300

  WriteLatencyHighEvaluationPeriods:
    Description: The number of periods over which data is compared to the specified write latency threshold.
    Type: Number
    Default: 1

  StorageLowThreshold:
    Description: The threshold at which the RDS instance's storage triggers an alarm (gigabytes).
    Type: Number

  StorageLowPeriod:
    Description: The number of seconds over which the RDS instance's storage is sampled.
    Type: Number
    Default: 300

  StorageLowEvaluationPeriods:
    Description: The number of periods over which data is compared to the specified low storage threshold.
    Type: Number
    Default: 1

  MonitoringIntervalInSeconds:
    Description: >
      The interval, in seconds, between points when Enhanced Monitoring metrics
      are collected for the DB instance. To disable collecting Enhanced
      Monitoring metrics, specify 0. The default is 0.
    Type: Number
    Default: 0
    AllowedValues: [0, 1, 5, 10, 15, 30, 60]

  DBSnapshotIdentifier:
    Type: String
    Default: ''
    Description: >
      The identifier for the DB cluster snapshot from which you want to restore.

  SourceDBInstanceIdentifier:
    Type: String
    Default: ''
    Description: >
      Specify only when creating a read replica

  ParameterGroupFamily:
    Type: String
    Default: ''
    Description: >
      The parameter group family to use.

  EnablePerformanceInsights:
    Type: String
    Description: The parameter to enable or disable Performance Insights.
    Default: "false"
    AllowedValues: ["true", "false"]

  PerformanceInsightsRetentionPeriod:
    Description: The amount of time, in days, to retain Performance Insights data.
    Type: Number
    Default: 7
    MinValue: 7
    MaxValue: 731

Conditions:

  EnvIsProd: !Equals [!Ref EnvironmentName, prod]
  HasEnhancedMonitoring: !Not [!Equals [!Ref MonitoringIntervalInSeconds, 0]]
  IsReadReplica: !Not [!Equals [!Ref SourceDBInstanceIdentifier, '']]
  HasDBSnapshotIdentifier: !And
    - !Not [!Condition IsReadReplica]
    - !Not [!Equals [!Ref DBSnapshotIdentifier, '']]
  HasMaxWorkerProcesses: !Not [!Equals [!Ref MaxWorkerProcesses, 0]]
  HasSharedBuffers: !Not [!Equals [!Ref SharedBuffers, 0]]
  HasParameterGroupFamily: !Not [!Equals [!Ref ParameterGroupFamily, '']]
  HasPerformanceInsightsEnabled: !Equals [!Ref EnablePerformanceInsights, "true"]


Mappings:

  InstanceClasses:

    # Last updated 2018-11-06
    # Docs: https://aws.amazon.com/rds/instance-types/

    # Burstable Performance

    db.t2.micro:
      CpuCount: 1
    db.t2.small:
      CpuCount: 1
    db.t2.medium:
      CpuCount: 2
    db.t2.large:
      CpuCount: 2
    db.t2.xlarge:
      CpuCount: 4
    db.t2.2xlarge:
      CpuCount: 8

    # Memory Optimized

    db.r3.large:
      CpuCount: 2
    db.r3.xlarge:
      CpuCount: 4
    db.r3.2xlarge:
      CpuCount: 8
    db.r3.4xlarge:
      CpuCount: 16
    db.r3.8xlarge:
      CpuCount: 32

    db.r4.large:
      CpuCount: 2
    db.r4.xlarge:
      CpuCount: 4
    db.r4.2xlarge:
      CpuCount: 8
    db.r4.4xlarge:
      CpuCount: 16
    db.r4.8xlarge:
      CpuCount: 32
    db.r4.16xlarge:
      CpuCount: 64

    db.r5.large:
      CpuCount: 2
    db.r5.xlarge:
      CpuCount: 4
    db.r5.2xlarge:
      CpuCount: 8
    db.r5.4xlarge:
      CpuCount: 16
    db.r5.12xlarge:
      CpuCount: 48
    db.r5.24xlarge:
      CpuCount: 96

    db.x1e.xlarge:
      CpuCount: 4
    db.x1e.2xlarge:
      CpuCount: 8
    db.x1e.4xlarge:
      CpuCount: 16
    db.x1e.8xlarge:
      CpuCount: 32
    db.x1e.16xlarge:
      CpuCount: 64
    db.x1e.32xlarge:
      CpuCount: 128

    # General Purpose

    db.m3.medium:
      CpuCount: 1
    db.m4.large:
      CpuCount: 2
    db.m4.xlarge:
      CpuCount: 4
    db.m4.2xlarge:
      CpuCount: 8
    db.m4.4xlarge:
      CpuCount: 16
    db.m4.10xlarge:
      CpuCount: 40
    db.m4.16xlarge:
      CpuCount: 64

    db.m5.large:
      CpuCount: 2
    db.m5.xlarge:
      CpuCount: 4
    db.m5.2xlarge:
      CpuCount: 8
    db.m5.4xlarge:
      CpuCount: 16
    db.m5.12xlarge:
      CpuCount: 48
    db.m5.24xlarge:
      CpuCount: 96


Resources:

  SubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: !Sub Subnet group for the ${EnvironmentName}-${InstanceName} RDS instance.
      SubnetIds: !Split
        - ","
        - Fn::ImportValue: !Sub ${EnvironmentName}:stacksets:v2:env:vpc:private-subnets

  ParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Description: !Sub Parameter group for the ${EnvironmentName}-${InstanceName} RDS instance.
      Family: !If
        - HasParameterGroupFamily
        - !Ref ParameterGroupFamily
        - !Sub
          - postgres${Major}.${Minor}
          - Major: !Select [0, !Split [".", !Ref EngineVersion]]
            Minor: !Select [1, !Split [".", !Ref EngineVersion]]
      Parameters:

        # STATIC PARAMETERS:
        # "During an update, if you have static parameters (whether they were changed or not), triggers AWS CloudFormation to reboot the associated DB instance without failover."
        # - FROM https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-dbparametergroup.html#cfn-rds-dbparametergroup-parameters
        # Static vs Non-Static docs: https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Appendix.PostgreSQL.CommonDBATasks.html#Appendix.PostgreSQL.CommonDBATasks.Parameters

        # no need to have ssl enabled, the instance will only be reachable from inside the VPC
        ssl: 0
        shared_buffers: !If [HasSharedBuffers, !Ref SharedBuffers, !Ref 'AWS::NoValue']

        # DYNAMIC PARAMETERS:
        # changing these options does not lead to service interruption as long as you do not have any static parameters defined

        log_autovacuum_min_duration: 5000 # unit=ms

        # make sure have have one worker per core
        max_worker_processes: !If
          - HasMaxWorkerProcesses
          - !Ref MaxWorkerProcesses
          - !FindInMap [InstanceClasses, !Ref InstanceClass, CpuCount]

  Instance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Retain # note, this is ignored if this is a read replica; see the "SourceDBInstanceIdentifier" section of https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-rds-database-instance.html#cfn-rds-dbinstance-dbsnapshotidentifier
    Properties:
      DBInstanceIdentifier: !Sub ${EnvironmentName}-${InstanceName}
      SourceDBInstanceIdentifier: !If
        - IsReadReplica
        - !Ref SourceDBInstanceIdentifier
        - !Ref AWS::NoValue
      DBSnapshotIdentifier: !If
        - HasDBSnapshotIdentifier
        - !Ref DBSnapshotIdentifier
        - !Ref AWS::NoValue
      CopyTagsToSnapshot: true
      DBName: !If
        - IsReadReplica # a read replica instance cannot have this setting defined
        - !Ref AWS::NoValue
        - !If [HasDBSnapshotIdentifier, !Ref 'AWS::NoValue', !Ref DBName]
      DBInstanceClass: !Ref InstanceClass
      DeletionProtection: !If [ EnvIsProd, true, !Ref "AWS::NoValue" ]
      Engine: postgres
      EngineVersion: !Ref EngineVersion
      AutoMinorVersionUpgrade: true
      StorageType: !Ref StorageType
      AllocatedStorage: !If
        - IsReadReplica # a read replica instance cannot have this setting defined
        - !Ref AWS::NoValue
        - !Ref AllocatedStorage
      DBParameterGroupName: !Ref ParameterGroup
      DBSubnetGroupName: !If
        - IsReadReplica # a read replica instance cannot have this setting defined if the source instance is in the same region
        - !Ref AWS::NoValue
        - !Ref SubnetGroup
      VPCSecurityGroups:
        - Fn::ImportValue: !Sub ${EnvironmentName}:stacksets:v2:env:vpc:default-security-group
      MultiAZ: !If
        - IsReadReplica # a read replica instance cannot have MultiAZ set to True
        - false
        - !If [EnvIsProd, true, false]
      MasterUsername: !If
        - IsReadReplica # a read replica instance cannot have this setting defined
        - !Ref AWS::NoValue
        - !If [HasDBSnapshotIdentifier, !Ref 'AWS::NoValue', root]
      MasterUserPassword: !If
        - IsReadReplica # a read replica instance cannot have this setting defined
        - !Ref AWS::NoValue
        - !If [HasDBSnapshotIdentifier, !Ref 'AWS::NoValue', !Ref RootPassword]
      StorageEncrypted: !If
        - IsReadReplica # a read replica instance cannot have this setting defined
        - !Ref AWS::NoValue
        - !Ref StorageEncrypted
      PubliclyAccessible: false
      BackupRetentionPeriod: !If
        - IsReadReplica # a read replica instance cannot have this setting defined
        - !Ref AWS::NoValue
        - !If [EnvIsProd, 35, 7]
      MonitoringInterval: !Ref MonitoringIntervalInSeconds
      MonitoringRoleArn: !If
        - HasEnhancedMonitoring
        - !GetAtt EnhancedMonitoringRole.Arn
        - !Ref AWS::NoValue
      EnablePerformanceInsights: !Ref EnablePerformanceInsights
      PerformanceInsightsRetentionPeriod: !If
        - HasPerformanceInsightsEnabled
        - !Ref PerformanceInsightsRetentionPeriod
        - !Ref AWS::NoValue

  CPUHighAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${EnvironmentName}-${InstanceName}-high-cpu
      AlarmDescription: !Sub Notify when the ${EnvironmentName}-${InstanceName} RDS instance CPU is high.
      Namespace: AWS/RDS
      MetricName: CPUUtilization
      Unit: Percent
      Statistic: Average
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: !Ref CPUHighThreshold
      Period: !Ref CPUHighPeriod
      EvaluationPeriods: !Ref CPUHighEvaluationPeriods
      ActionsEnabled: true
      AlarmActions:
        - Fn::ImportValue: !Sub
          - ${EnvironmentName}-${VerticalName}-${Urgency}-urgency-alerts-topic-arn
          - Urgency: !If [EnvIsProd, critical, low]
      OKActions:
        - Fn::ImportValue: !Sub
          - ${EnvironmentName}-${VerticalName}-${Urgency}-urgency-alerts-topic-arn
          - Urgency: !If [EnvIsProd, critical, low]
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref Instance

  ReadIopsHighAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${EnvironmentName}-${InstanceName}-high-read-iops
      AlarmDescription: !Sub Notify when the ${EnvironmentName}-${InstanceName} RDS instance read IOPS are high.
      Namespace: AWS/RDS
      MetricName: ReadIOPS
      Unit: Count/Second
      Statistic: Average
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: !Ref ReadIOPSHighThreshold
      Period: !Ref ReadIOPSHighPeriod
      EvaluationPeriods: !Ref ReadIOPSHighEvaluationPeriods
      ActionsEnabled: true
      AlarmActions:
        - Fn::ImportValue: !Sub
          - ${EnvironmentName}-${VerticalName}-${Urgency}-urgency-alerts-topic-arn
          - Urgency: !If [EnvIsProd, critical, low]
      OKActions:
        - Fn::ImportValue: !Sub
          - ${EnvironmentName}-${VerticalName}-${Urgency}-urgency-alerts-topic-arn
          - Urgency: !If [EnvIsProd, critical, low]
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref Instance

  WriteIopsHighAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${EnvironmentName}-${InstanceName}-high-write-iops
      AlarmDescription: !Sub Notify when the ${EnvironmentName}-${InstanceName} RDS instance write IOPS are high.
      Namespace: AWS/RDS
      MetricName: WriteIOPS
      Unit: Count/Second
      Statistic: Average
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: !Ref WriteIOPSHighThreshold
      Period: !Ref WriteIOPSHighPeriod
      EvaluationPeriods: !Ref WriteIOPSHighEvaluationPeriods
      ActionsEnabled: true
      AlarmActions:
        - Fn::ImportValue: !Sub
          - ${EnvironmentName}-${VerticalName}-${Urgency}-urgency-alerts-topic-arn
          - Urgency: !If [EnvIsProd, critical, low]
      OKActions:
        - Fn::ImportValue: !Sub
          - ${EnvironmentName}-${VerticalName}-${Urgency}-urgency-alerts-topic-arn
          - Urgency: !If [EnvIsProd, critical, low]
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref Instance

  ReadLatencyHighAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${EnvironmentName}-${InstanceName}-high-read-latency
      AlarmDescription: !Sub Notify when the ${EnvironmentName}-${InstanceName} RDS instance read latency is high.
      Namespace: AWS/RDS
      MetricName: ReadLatency
      Unit: Milliseconds
      Statistic: Average
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: !Ref ReadLatencyHighThreshold
      Period: !Ref ReadLatencyHighPeriod
      EvaluationPeriods: !Ref ReadLatencyHighEvaluationPeriods
      ActionsEnabled: true
      AlarmActions:
        - Fn::ImportValue: !Sub
          - ${EnvironmentName}-${VerticalName}-${Urgency}-urgency-alerts-topic-arn
          - Urgency: !If [EnvIsProd, critical, low]
      OKActions:
        - Fn::ImportValue: !Sub
          - ${EnvironmentName}-${VerticalName}-${Urgency}-urgency-alerts-topic-arn
          - Urgency: !If [EnvIsProd, critical, low]
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref Instance

  WriteLatencyHighAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${EnvironmentName}-${InstanceName}-high-write-latency
      AlarmDescription: !Sub Notify when the ${EnvironmentName}-${InstanceName} RDS instance write latency is high.
      Namespace: AWS/RDS
      MetricName: WriteLatency
      Unit: Milliseconds
      Statistic: Average
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: !Ref WriteLatencyHighThreshold
      Period: !Ref WriteLatencyHighPeriod
      EvaluationPeriods: !Ref WriteLatencyHighEvaluationPeriods
      ActionsEnabled: true
      AlarmActions:
        - Fn::ImportValue: !Sub
          - ${EnvironmentName}-${VerticalName}-${Urgency}-urgency-alerts-topic-arn
          - Urgency: !If [EnvIsProd, critical, low]
      OKActions:
        - Fn::ImportValue: !Sub
          - ${EnvironmentName}-${VerticalName}-${Urgency}-urgency-alerts-topic-arn
          - Urgency: !If [EnvIsProd, critical, low]
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref Instance

  StorageLowAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${EnvironmentName}-${InstanceName}-low-storage
      AlarmDescription: !Sub Notify when the ${EnvironmentName}-${InstanceName} RDS instance storage is low.
      Namespace: AWS/RDS
      MetricName: FreeStorageSpace
      Unit: Gigabytes
      Statistic: Average
      ComparisonOperator: LessThanOrEqualToThreshold
      Threshold: !Ref StorageLowThreshold
      Period: !Ref StorageLowPeriod
      EvaluationPeriods: !Ref StorageLowEvaluationPeriods
      ActionsEnabled: true
      AlarmActions:
        - Fn::ImportValue: !Sub
          - ${EnvironmentName}-${VerticalName}-${Urgency}-urgency-alerts-topic-arn
          - Urgency: !If [EnvIsProd, critical, low]
      OKActions:
        - Fn::ImportValue: !Sub
          - ${EnvironmentName}-${VerticalName}-${Urgency}-urgency-alerts-topic-arn
          - Urgency: !If [EnvIsProd, critical, low]
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref Instance

  HostParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${EnvironmentName}/rds/${InstanceName}/host
      Description: !Sub Automated by CloudFormation (${AWS::StackName})
      Type: String
      Value: !GetAtt Instance.Endpoint.Address

  PortParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${EnvironmentName}/rds/${InstanceName}/port
      Description: !Sub Automated by CloudFormation (${AWS::StackName})
      Type: String
      Value: !GetAtt Instance.Endpoint.Port

  EnhancedMonitoringRole:
    Type: AWS::IAM::Role
    Condition: HasEnhancedMonitoring
    Properties:
      Path: /
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: monitoring.rds.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole'

  PostgresInstanceMonitor:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/cloudformation.adela.it/templates/shared/db/addons/instance-monitor.yml
      Parameters:
        Instance: !Ref Instance
        EnvironmentName: !Ref EnvironmentName
        VerticalName: !Ref VerticalName

  PostgresIOPSMonitor:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/cloudformation.adela.it/templates/shared/db/addons/iops-monitor.yml
      Parameters:
        Instance: !Ref Instance
        EnvironmentName: !Ref EnvironmentName
        VerticalName: !Ref VerticalName
        IOPSThreshold: !Ref UnifiedIOPSHighThreshold


Outputs:

  Host:
    Description: The RDS host.
    Value: !GetAtt Instance.Endpoint.Address

  Port:
    Description: The RDS port.
    Value: !GetAtt Instance.Endpoint.Port

  DBInstanceIdentifier:
    Description: The RDS DBInstanceIdentifier
    Value: !Ref Instance

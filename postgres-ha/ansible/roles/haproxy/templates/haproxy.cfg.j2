global
    daemon
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy

    # Default SSL material locations
    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    retries 3
    option redispatch

# Stats configuration
listen stats
    bind {{ private_ip }}:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats realm Haproxy\ Statistics
    stats auth admin:admin

# PostgreSQL primary/secondary configuration
listen postgres_primary
    bind {{ private_ip }}:5432
    mode tcp
    option httpchk GET /primary
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
{% for host in groups['postgres_nodes'] %}
    server {{ host }} {{ hostvars[host]['private_ip'] }}:5432 maxconn 100 check port 8008
{% endfor %}

# PostgreSQL read-only configuration (optional)
listen postgres_replica
    bind {{ private_ip }}:5433
    mode tcp
    option httpchk GET /replica
    http-check expect status 200
    default-server inter 3s fall 3 rise 2
{% for host in groups['postgres_nodes'] %}
    server {{ host }} {{ hostvars[host]['private_ip'] }}:5432 maxconn 100 check port 8008
{% endfor %}